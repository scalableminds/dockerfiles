name: CI

on: [push]

jobs:
  build:
    strategy:
      matrix:
        app:
          - cronut
          - duply
          - events-relay
          - helm
          - kubectl
          - nginx-proxy
          - puppeteer
          - s3-proxy
          - sbt
          - slurm-docker-cluster
          - wklink
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Build docker images
      run: |
        export CI_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        export NORMALIZED_CI_BRANCH=${CI_BRANCH//[\/-]/_}
        ./build.sh ${{ matrix.app }}

    - name: Run tests
      run: ./test.sh ${{ matrix.app }}

    - name: Push docker images
      env: 
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
      run: |
        export CI_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        export NORMALIZED_CI_BRANCH=${CI_BRANCH//[\/-]/_}
        does_repo_exist() {
          curl --silent -f -lSL https://index.docker.io/v1/repositories/scalableminds/$1/tags > /dev/null
        }

        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

        if does_repo_exist ${{ matrix.app }}; then
          docker push scalableminds/${{ matrix.app }}:${NORMALIZED_CI_BRANCH}__${GITHUB_RUN_ID}
          docker push scalableminds/${{ matrix.app }}:${NORMALIZED_CI_BRANCH}
        else
          docker tag \
            scalableminds/${{ matrix.app }}:${NORMALIZED_CI_BRANCH}__${GITHUB_RUN_ID} \
            scalableminds/various:${{ matrix.app }}__${NORMALIZED_CI_BRANCH}__${GITHUB_RUN_ID}
          docker push scalableminds/various:${{ matrix.app }}__${NORMALIZED_CI_BRANCH}__${GITHUB_RUN_ID}
          docker tag \
            scalableminds/${{ matrix.app }}:${NORMALIZED_CI_BRANCH} \
            scalableminds/various:${{ matrix.app }}__${NORMALIZED_CI_BRANCH}
          docker push scalableminds/various:${{ matrix.app }}__${NORMALIZED_CI_BRANCH}
        fi

        docker logout
